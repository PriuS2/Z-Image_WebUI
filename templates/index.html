<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Z-Image WebUI</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.0.0/fonts/remixicon.css" rel="stylesheet">
    <!-- JSZip for batch download -->
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- 사이드바 -->
        <aside class="sidebar">
            <div class="logo">
                <i class="ri-image-ai-line"></i>
                <span>Z-Image</span>
            </div>
            
            <nav class="nav-menu">
                <button class="nav-item active" data-tab="chat">
                    <i class="ri-chat-3-line"></i>
                    <span>대화</span>
                </button>
                <button class="nav-item" data-tab="edit">
                    <i class="ri-edit-line"></i>
                    <span>편집</span>
                </button>
                <button class="nav-item" data-tab="gallery">
                    <i class="ri-gallery-line"></i>
                    <span>갤러리</span>
                </button>
                <button class="nav-item" data-tab="history">
                    <i class="ri-history-line"></i>
                    <span>히스토리</span>
                </button>
                <button class="nav-item" data-tab="edit-history">
                    <i class="ri-image-edit-line"></i>
                    <span>편집기록</span>
                </button>
                <button class="nav-item" data-tab="favorites">
                    <i class="ri-star-line"></i>
                    <span>즐겨찾기</span>
                </button>
                <button class="nav-item" data-tab="settings">
                    <i class="ri-settings-3-line"></i>
                    <span>설정</span>
                </button>
            </nav>
            
            <div class="model-status" id="modelStatus">
                <div class="status-indicator offline"></div>
                <span>모델 미로드</span>
            </div>
            
            <div class="user-count" id="userCount" title="현재 접속자 수">
                <i class="ri-user-line"></i>
                <span id="userCountText">1</span>
            </div>
            
            <!-- 로그인된 사용자 정보 -->
            <div class="user-info" id="userInfo" title="로그인 정보">
                <i class="ri-user-3-fill"></i>
                <span id="currentUsername">{{ user.username if user else '' }}</span>
            </div>
        </aside>
        
        <!-- 메인 컨텐츠 -->
        <main class="main-content">
            <!-- 대화 탭 -->
            <section class="tab-content active" id="tab-chat">
                <div class="chat-container">
                    <!-- 모델 상태 바 (스크롤과 상관없이 상단 고정) -->
                    <div class="chat-sticky-header">
                        <div class="model-control-bar" id="modelControlBar">
                            <div class="model-info">
                                <div class="model-status-badge" id="modelStatusBadge">
                                    <span class="status-dot offline"></span>
                                    <span class="status-text">모델 미로드</span>
                                </div>
                            </div>
                            <div class="model-actions">
                                <button class="btn btn-sm btn-primary" id="btnChatLoadModel" title="모델 로드">
                                    <i class="ri-download-line"></i> 로드
                                </button>
                                <button class="btn btn-sm btn-danger" id="btnChatUnloadModel" title="모델 언로드">
                                    <i class="ri-close-line"></i> 언로드
                                </button>
                            </div>
                        </div>
                        
                        <!-- 프로그레스 바 -->
                        <div class="progress-container" id="progressContainer" style="display: none;">
                            <div class="progress-info">
                                <span class="progress-label" id="progressLabel">모델 로딩 중...</span>
                                <span class="progress-percent" id="progressPercent">0%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                            </div>
                            <div class="progress-detail" id="progressDetail"></div>
                        </div>
                        
                        <!-- 큐 상태 표시 -->
                        <div class="queue-status" id="queueStatus" style="display: none;">
                            <div class="queue-status-icon">
                                <i class="ri-time-line"></i>
                            </div>
                            <div class="queue-status-text" id="queueStatusText">대기 중...</div>
                            <div class="queue-status-position" id="queueStatusPosition"></div>
                        </div>
                    </div>
                    
                    <div class="chat-messages" id="chatMessages">
                        <div class="message system">
                            <div class="message-content">
                                <p>👋 안녕하세요! Z-Image WebUI입니다.</p>
                                <p>이미지를 생성하려면 프롬프트를 입력하세요.</p>
                                <p>위의 <strong>로드</strong> 버튼을 눌러 모델을 먼저 로드해주세요.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chat-input-container">
                        <div class="input-options">
                            <button class="option-btn" id="btnTemplate" title="템플릿">
                                <i class="ri-file-list-3-line"></i>
                            </button>
                            <button class="option-btn" id="btnTranslate" title="번역">
                                <i class="ri-translate-2"></i>
                            </button>
                            <button class="option-btn" id="btnEnhance" title="AI 향상">
                                <i class="ri-magic-line"></i>
                            </button>
                        </div>
                        
                        <div class="input-row korean-input-row">
                            <div class="input-label">
                                <i class="ri-translate-2"></i>
                                <span>한국어 입력</span>
                                <button class="btn btn-xs btn-primary" id="btnTranslateKorean" title="한국어를 영어로 번역">
                                    <i class="ri-translate-2"></i> 번역
                                </button>
                            </div>
                            <textarea id="koreanInput" placeholder="여기에 한국어로 입력하세요..." rows="2"></textarea>
                        </div>
                        
                        <div class="input-row english-prompt-row">
                            <div class="input-label">
                                <i class="ri-english-input"></i>
                                <span>실제 프롬프트 (영어)</span>
                                <span class="translate-status" id="translateStatus"></span>
                            </div>
                            <textarea id="promptInput" placeholder="English prompt will appear here... (직접 편집 가능)" rows="3"></textarea>
                        </div>
                        
                        <div class="input-actions">
                            <div class="quick-settings">
                                <div class="setting-with-tooltip">
                                    <select id="resolutionSelect" title="해상도: 이미지 크기 (클수록 고품질, VRAM 더 사용)">
                                        <option value="512x512">512×512</option>
                                        <option value="768x768">768×768</option>
                                        <option value="1024x1024">1024×1024</option>
                                        <option value="512x768">512×768 (세로)</option>
                                        <option value="768x512">768×512 (가로)</option>
                                        <option value="custom">📐 커스텀</option>
                                    </select>
                                    <span class="tooltip-icon" data-tooltip="해상도: 생성할 이미지의 크기입니다. 512×512가 기본이며, 클수록 더 세밀한 이미지를 생성하지만 VRAM을 더 사용합니다.">?</span>
                                </div>
                                
                                <!-- 커스텀 해상도 입력 -->
                                <div class="custom-resolution" id="customResolution" style="display: none;">
                                    <input type="number" id="customWidth" placeholder="너비" value="512" min="256" max="2048" step="64">
                                    <span>×</span>
                                    <input type="number" id="customHeight" placeholder="높이" value="512" min="256" max="2048" step="64">
                                </div>
                                
                                <div class="setting-with-tooltip">
                                    <input type="number" id="seedInput" placeholder="시드" value="-1" title="시드: -1=랜덤, 같은 숫자=같은 이미지">
                                    <span class="tooltip-icon" data-tooltip="시드: 이미지 생성의 기준 숫자입니다. -1은 랜덤이며, 같은 시드+프롬프트는 같은 이미지를 생성합니다. 결과가 마음에 들면 시드를 기억해두세요!">?</span>
                                </div>
                                
                                <div class="setting-with-tooltip">
                                    <input type="number" id="stepsInput" placeholder="스텝" value="8" min="1" max="50" title="스텝: 높을수록 품질↑ 속도↓">
                                    <span class="tooltip-icon" data-tooltip="스텝(Steps): 이미지를 다듬는 횟수입니다. 4~8이 기본, 높을수록 품질이 좋아지지만 시간이 더 걸립니다. Z-Image는 Turbo 모델이라 4~12스텝이면 충분합니다.">?</span>
                                </div>
                                
                                <div class="setting-with-tooltip">
                                    <input type="number" id="numImagesInput" placeholder="개수" value="1" min="1" max="10" title="한 번에 생성할 이미지 개수">
                                    <span class="tooltip-icon" data-tooltip="생성 개수: 한 번에 몇 장의 이미지를 만들지 설정합니다. 각 이미지는 시드가 1씩 증가하며, 여러 변형을 비교하고 싶을 때 유용합니다.">?</span>
                                </div>
                            </div>
                            <div class="action-buttons">
                                <button class="btn btn-secondary" id="btnPreview" title="256×256 크기로 빠르게 미리보기">
                                    <i class="ri-eye-line"></i> 미리보기
                                </button>
                                <button class="btn btn-primary" id="btnGenerate" title="설정된 해상도로 이미지 생성">
                                    <i class="ri-brush-line"></i> 생성
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- 편집 탭 -->
            <section class="tab-content" id="tab-edit">
                <div class="chat-container">
                    <!-- 편집 모델 상태 바 -->
                    <div class="chat-sticky-header">
                        <div class="model-control-bar" id="editModelControlBar">
                            <div class="model-info">
                                <div class="model-status-badge" id="editModelStatusBadge">
                                    <span class="status-dot offline"></span>
                                    <span class="status-text">편집 모델 미로드</span>
                                </div>
                            </div>
                            <div class="model-actions">
                                <button class="btn btn-sm btn-primary" id="btnEditLoadModel" title="편집 모델 로드">
                                    <i class="ri-download-line"></i> 로드
                                </button>
                                <button class="btn btn-sm btn-danger" id="btnEditUnloadModel" title="편집 모델 언로드">
                                    <i class="ri-close-line"></i> 언로드
                                </button>
                            </div>
                        </div>
                        
                        <!-- 프로그레스 바 -->
                        <div class="progress-container" id="editProgressContainer" style="display: none;">
                            <div class="progress-info">
                                <span class="progress-label" id="editProgressLabel">모델 로딩 중...</span>
                                <span class="progress-percent" id="editProgressPercent">0%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="editProgressFill" style="width: 0%"></div>
                            </div>
                            <div class="progress-detail" id="editProgressDetail"></div>
                        </div>
                    </div>
                    
                    <div class="chat-messages" id="editMessages">
                        <div class="message system">
                            <div class="message-content">
                                <p>🎨 LongCat-Image-Edit에 오신 것을 환영합니다!</p>
                                <p>이미지를 업로드하고 편집 지시어를 입력하세요.</p>
                                <p>위의 <strong>로드</strong> 버튼을 눌러 편집 모델을 먼저 로드해주세요.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chat-input-container edit-input-container">
                        <!-- 이미지 업로드 영역 -->
                        <div class="edit-image-area">
                            <div class="image-upload-box" id="editImageUpload">
                                <input type="file" id="editImageInput" accept="image/*" style="display: none;">
                                <div class="upload-placeholder" id="editUploadPlaceholder">
                                    <i class="ri-upload-cloud-line"></i>
                                    <span>이미지 업로드 또는 드래그</span>
                                    <button class="btn btn-secondary btn-sm" id="btnSelectFromGallery">
                                        <i class="ri-gallery-line"></i> 갤러리에서 선택
                                    </button>
                                </div>
                                <div class="upload-preview" id="editUploadPreview" style="display: none;">
                                    <img id="editPreviewImage" src="" alt="편집할 이미지">
                                    <button class="btn btn-xs btn-danger" id="btnRemoveEditImage" title="이미지 제거">
                                        <i class="ri-close-line"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="reference-image-box" id="referenceImageBox">
                                <input type="file" id="referenceImageInput" accept="image/*" style="display: none;">
                                <div class="upload-placeholder" id="referencePlaceholder">
                                    <i class="ri-image-add-line"></i>
                                    <span>참조 이미지 (선택)</span>
                                </div>
                                <div class="upload-preview" id="referencePreview" style="display: none;">
                                    <img id="referencePreviewImage" src="" alt="참조 이미지">
                                    <button class="btn btn-xs btn-danger" id="btnRemoveRefImage" title="참조 이미지 제거">
                                        <i class="ri-close-line"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="input-options">
                            <button class="option-btn" id="btnEditTranslate" title="번역">
                                <i class="ri-translate-2"></i>
                            </button>
                            <button class="option-btn" id="btnEditEnhance" title="AI 향상">
                                <i class="ri-magic-line"></i>
                            </button>
                            <button class="option-btn" id="btnEditSuggest" title="편집 제안">
                                <i class="ri-lightbulb-line"></i>
                            </button>
                        </div>
                        
                        <div class="input-row korean-input-row">
                            <div class="input-label">
                                <i class="ri-translate-2"></i>
                                <span>한국어 편집 지시어</span>
                                <button class="btn btn-xs btn-primary" id="btnEditTranslateKorean" title="한국어를 영어로 번역">
                                    <i class="ri-translate-2"></i> 번역
                                </button>
                            </div>
                            <textarea id="editKoreanInput" placeholder="예: 고양이를 강아지로 변경" rows="2"></textarea>
                        </div>
                        
                        <div class="input-row english-prompt-row">
                            <div class="input-label">
                                <i class="ri-english-input"></i>
                                <span>편집 프롬프트 (영어)</span>
                                <span class="translate-status" id="editTranslateStatus"></span>
                            </div>
                            <textarea id="editPromptInput" placeholder="예: Change the cat to a dog" rows="2"></textarea>
                        </div>
                        
                        <div class="input-actions">
                            <div class="quick-settings">
                                <div class="setting-with-tooltip">
                                    <input type="number" id="editStepsInput" placeholder="스텝" value="50" min="10" max="100" title="추론 스텝">
                                    <span class="tooltip-icon" data-tooltip="스텝: 높을수록 품질↑ 속도↓. 기본 50, 범위 10-100">?</span>
                                </div>
                                <div class="setting-with-tooltip">
                                    <input type="number" id="editGuidanceInput" placeholder="가이던스" value="4.5" min="1" max="20" step="0.5" title="가이던스 스케일">
                                    <span class="tooltip-icon" data-tooltip="가이던스: 프롬프트 반영 강도. 기본 4.5">?</span>
                                </div>
                                <div class="setting-with-tooltip">
                                    <input type="number" id="editSeedInput" placeholder="시드" value="-1" title="시드: -1=랜덤">
                                    <span class="tooltip-icon" data-tooltip="시드: -1은 랜덤, 같은 시드는 같은 결과">?</span>
                                </div>
                                <div class="setting-with-tooltip">
                                    <input type="number" id="editNumImagesInput" placeholder="개수" value="1" min="1" max="4" title="생성 개수">
                                    <span class="tooltip-icon" data-tooltip="한 번에 생성할 편집 결과 개수 (1-4)">?</span>
                                </div>
                            </div>
                            <div class="action-buttons">
                                <button class="btn btn-primary" id="btnEdit" title="이미지 편집 실행">
                                    <i class="ri-edit-line"></i> 편집
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- 갤러리 탭 -->
            <section class="tab-content" id="tab-gallery">
                <div class="tab-header">
                    <h2><i class="ri-gallery-line"></i> 갤러리</h2>
                    <div class="tab-header-actions">
                        <div class="gallery-download-dropdown" id="galleryDownloadDropdown">
                            <button class="btn btn-primary" id="btnGalleryDownload">
                                <i class="ri-download-2-line"></i> 다운로드 <i class="ri-arrow-down-s-line"></i>
                            </button>
                            <div class="dropdown-menu" id="galleryDownloadMenu">
                                <button class="dropdown-item" id="btnDownloadAll">
                                    <i class="ri-folder-zip-line"></i> 전체 다운로드
                                    <span class="dropdown-item-desc" id="downloadAllCount">0장</span>
                                </button>
                                <div class="dropdown-divider"></div>
                                <div class="dropdown-label">생성 프로세스별</div>
                                <div class="dropdown-group-list" id="galleryGroupList">
                                    <!-- 동적으로 생성됨 -->
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-secondary" id="btnRefreshGallery">
                            <i class="ri-refresh-line"></i> 새로고침
                        </button>
                    </div>
                </div>
                <div class="gallery-grid" id="galleryGrid"></div>
            </section>
            
            <!-- 히스토리 탭 -->
            <section class="tab-content" id="tab-history">
                <div class="tab-header">
                    <h2><i class="ri-history-line"></i> 프롬프트 히스토리</h2>
                    <button class="btn btn-danger" id="btnClearHistory">
                        <i class="ri-delete-bin-line"></i> 삭제
                    </button>
                </div>
                <div class="history-list" id="historyList"></div>
            </section>
            
            <!-- 편집 히스토리 탭 -->
            <section class="tab-content" id="tab-edit-history">
                <div class="tab-header">
                    <h2><i class="ri-image-edit-line"></i> 편집 히스토리</h2>
                    <button class="btn btn-danger" id="btnClearEditHistory">
                        <i class="ri-delete-bin-line"></i> 삭제
                    </button>
                </div>
                <div class="edit-history-list" id="editHistoryList"></div>
            </section>
            
            <!-- 즐겨찾기 탭 -->
            <section class="tab-content" id="tab-favorites">
                <div class="tab-header">
                    <h2><i class="ri-star-line"></i> 즐겨찾기</h2>
                </div>
                <div class="favorites-list" id="favoritesList"></div>
            </section>
            
            <!-- 설정 탭 -->
            <section class="tab-content" id="tab-settings">
                <div class="tab-header">
                    <h2><i class="ri-settings-3-line"></i> 설정</h2>
                </div>
                
                <!-- 계정 설정 -->
                <div class="settings-section" id="accountSection">
                    <h3>👤 계정</h3>
                    <div class="account-info">
                        <div class="account-user">
                            <i class="ri-user-3-fill"></i>
                            <span id="accountUsername">{{ user.username if user else '' }}</span>
                            <span class="admin-badge" id="adminBadge" style="display: none;">관리자</span>
                        </div>
                    </div>
                    <div class="setting-actions">
                        <button class="btn btn-secondary" id="btnChangePassword">
                            <i class="ri-lock-password-line"></i> 비밀번호 변경
                        </button>
                        <button class="btn btn-danger" id="btnLogout">
                            <i class="ri-logout-box-line"></i> 로그아웃
                        </button>
                    </div>
                </div>

                <!-- GPU 설정/모니터링 (관리자 전용) -->
                <div class="settings-section" id="gpuManagementSection" style="display: none;">
                    <h3>🖥️ GPU 설정/모니터링 (관리자 전용)</h3>
                    <p class="setting-description">
                        대화탭(이미지 생성)과 편집탭 모델을 서로 다른 GPU로 로드할 수 있습니다. (localhost 관리자만)
                    </p>

                    <div class="setting-group">
                        <label>생성 모델 GPU</label>
                        <select id="generationGpuSelect">
                            <option value="auto">auto</option>
                            <option value="cpu">cpu</option>
                        </select>
                        <small class="setting-hint">auto: 가장 여유로운 GPU 자동 선택</small>
                    </div>

                    <div class="setting-group">
                        <label>편집 모델 GPU</label>
                        <select id="editGpuSelect">
                            <option value="auto">auto</option>
                            <option value="cpu">cpu</option>
                        </select>
                        <small class="setting-hint">편집 모델은 VRAM을 많이 사용하므로 별도 GPU 권장</small>
                    </div>

                    <div class="setting-actions">
                        <button class="btn btn-secondary" id="btnRefreshGpuStatus" title="GPU 상태 새로고침">
                            <i class="ri-refresh-line"></i> GPU 상태 새로고침
                        </button>
                        <button class="btn btn-primary" id="btnSaveGpuSettings" title="GPU 설정 저장">
                            <i class="ri-save-line"></i> GPU 설정 저장
                        </button>
                    </div>

                    <div class="gpu-status-box">
                        <div class="gpu-status-summary" id="gpuStatusSummary"></div>
                        <div class="gpu-status-list" id="gpuStatusList"></div>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>🤖 모델 설정 (관리자 설정)</h3>
                    <p class="setting-description">양자화/CPU 오프로딩 옵션은 관리자만 변경할 수 있으며, 선택값은 서버에 저장됩니다.</p>
                    <div class="setting-group">
                        <label>양자화</label>
                        <select id="quantizationSelect">
                            <option value="BF16 (기본, 최고품질)">BF16 (기본, 최고품질)</option>
                            <!-- 서버에서 동적으로 옵션을 로드합니다 -->
                        </select>
                    </div>
                    <div class="setting-group">
                        <label>
                            <input type="checkbox" id="cpuOffloadCheck">
                            CPU 오프로딩 (VRAM 부족 시)
                        </label>
                    </div>
                    <div class="setting-actions">
                        <button class="btn btn-primary" id="btnLoadModel">
                            <i class="ri-download-line"></i> 모델 로드
                        </button>
                        <button class="btn btn-danger" id="btnUnloadModel">
                            <i class="ri-upload-line"></i> 모델 언로드
                        </button>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>🎨 LongCat-Image-Edit 모델 설정 (관리자 설정)</h3>
                    <p class="setting-description">양자화/CPU 오프로딩 옵션은 관리자만 변경할 수 있으며, 선택값은 서버에 저장됩니다.</p>
                    <div class="setting-group">
                        <label>양자화</label>
                        <select id="editQuantizationSelectSettings">
                            <option value="BF16 (기본, 최고품질)">BF16 (기본, 최고품질)</option>
                            <!-- 서버에서 동적으로 옵션을 로드합니다 -->
                        </select>
                    </div>
                    <div class="setting-group">
                        <label>
                            <input type="checkbox" id="editCpuOffloadCheckSettings" checked>
                            CPU 오프로딩 (권장, VRAM ~19GB 필요)
                        </label>
                        <small class="setting-hint">편집 모델은 용량이 크므로 CPU 오프로딩을 권장합니다.</small>
                    </div>
                    <div class="setting-actions">
                        <button class="btn btn-primary" id="btnLoadEditModelSettings">
                            <i class="ri-download-line"></i> 편집 모델 로드
                        </button>
                        <button class="btn btn-danger" id="btnUnloadEditModelSettings">
                            <i class="ri-upload-line"></i> 편집 모델 언로드
                        </button>
                    </div>
                </div>
                
                <div class="settings-section" id="autoUnloadSection">
                    <h3>⏰ 자동 언로드 설정 (Z-Image)</h3>
                    <p class="setting-description">웹 접속이나 조작이 없으면 자동으로 모델을 언로드하여 VRAM을 절약합니다. (관리자 전용)</p>
                    <div class="setting-group">
                        <label>
                            <input type="checkbox" id="autoUnloadEnabledCheck" checked>
                            자동 언로드 활성화
                        </label>
                    </div>
                    <div class="setting-group">
                        <label>자동 언로드 시간 (분)</label>
                        <div class="input-with-unit">
                            <input type="number" id="autoUnloadTimeoutInput" value="10" min="1" max="1440" step="1">
                            <span class="unit">분</span>
                        </div>
                        <small class="setting-hint">설정한 시간 동안 활동이 없으면 모델이 자동으로 언로드됩니다. (1~1440분)</small>
                    </div>
                    <button class="btn btn-secondary" id="btnSaveAutoUnload">
                        <i class="ri-save-line"></i> 자동 언로드 설정 저장
                    </button>
                </div>
                
                <div class="settings-section" id="editAutoUnloadSection">
                    <h3>⏰ 자동 언로드 설정 (LongCat-Image-Edit)</h3>
                    <p class="setting-description">편집 모델의 자동 언로드 설정입니다. (관리자 전용)</p>
                    <div class="setting-group">
                        <label>
                            <input type="checkbox" id="editAutoUnloadEnabledCheck" checked>
                            편집 모델 자동 언로드 활성화
                        </label>
                    </div>
                    <div class="setting-group">
                        <label>자동 언로드 시간 (분)</label>
                        <div class="input-with-unit">
                            <input type="number" id="editAutoUnloadTimeoutInput" value="10" min="1" max="1440" step="1">
                            <span class="unit">분</span>
                        </div>
                    </div>
                    <button class="btn btn-secondary" id="btnSaveEditAutoUnload">
                        <i class="ri-save-line"></i> 편집 모델 자동 언로드 설정 저장
                    </button>
                </div>
                
                <!-- 관리자 전용 안내 (외부 접속 시 표시) -->
                <div class="settings-section admin-notice" id="adminNotice" style="display: none;">
                    <div class="admin-notice-content">
                        <i class="ri-lock-line"></i>
                        <span>LLM API 설정은 관리자(localhost)만 변경할 수 있습니다.</span>
                    </div>
                </div>
                
                <div class="settings-section" id="llmSettingsSection">
                    <h3>🔑 LLM API 설정 (번역/프롬프트 향상)</h3>
                    <div class="setting-group">
                        <label>LLM Provider</label>
                        <select id="llmProviderSelect">
                            <option value="openai">OpenAI</option>
                            <!-- 서버에서 동적으로 로드 -->
                        </select>
                    </div>
                    <div class="setting-group">
                        <label>API 키</label>
                        <input type="password" id="llmApiKeyInput" placeholder="API 키를 입력하세요">
                    </div>
                    <div class="setting-group" id="llmBaseUrlGroup" style="display: none;">
                        <label>Base URL (커스텀 provider용)</label>
                        <input type="text" id="llmBaseUrlInput" placeholder="https://api.example.com/v1">
                    </div>
                    <div class="setting-group">
                        <label>모델 (비워두면 기본값 사용)</label>
                        <div class="model-input-wrapper">
                            <input type="text" id="llmModelInput" placeholder="모델명을 직접 입력 (비우면 기본값)" title="모델명을 직접 입력 (비우면 기본값)">
                        </div>
                    </div>
                    <div class="setting-info" id="llmProviderInfo">
                        <small>💡 OpenAI, OpenRouter, Groq, Together AI, Ollama, LM Studio 등 OpenAI 호환 API를 지원합니다.</small>
                    </div>
                    <button class="btn btn-secondary" id="btnSaveLlmSettings">
                        <i class="ri-save-line"></i> LLM 설정 저장
                    </button>
                </div>
                
                <div class="settings-section" id="systemPromptsSection">
                    <h3>📝 시스템 프롬프트 설정 (개인화)</h3>
                    <p class="setting-description">번역 및 프롬프트 향상 시 LLM에 전달되는 시스템 프롬프트입니다. 이 설정은 사용자별로 개인화됩니다.</p>
                    
                    <div class="setting-group">
                        <label>
                            번역 시스템 프롬프트
                            <button class="btn btn-xs btn-secondary" id="btnResetTranslatePrompt" title="기본값으로 초기화">
                                <i class="ri-restart-line"></i> 초기화
                            </button>
                        </label>
                        <textarea id="translateSystemPrompt" rows="6" placeholder="번역 시스템 프롬프트..."></textarea>
                    </div>
                    
                    <div class="setting-group">
                        <label>
                            향상 시스템 프롬프트
                            <button class="btn btn-xs btn-secondary" id="btnResetEnhancePrompt" title="기본값으로 초기화">
                                <i class="ri-restart-line"></i> 초기화
                            </button>
                        </label>
                        <textarea id="enhanceSystemPrompt" rows="8" placeholder="향상 시스템 프롬프트..."></textarea>
                    </div>
                    
                    <button class="btn btn-secondary" id="btnSaveSystemPrompts">
                        <i class="ri-save-line"></i> 시스템 프롬프트 저장
                    </button>
                </div>
                
                <div class="settings-section" id="editSystemPromptsSection">
                    <h3>🎨 편집 시스템 프롬프트 설정 (개인화)</h3>
                    <p class="setting-description">이미지 편집 시 LLM에 전달되는 시스템 프롬프트입니다. 이 설정은 사용자별로 개인화됩니다.</p>
                    
                    <div class="setting-group">
                        <label>
                            편집 지시어 번역 프롬프트
                            <button class="btn btn-xs btn-secondary" id="btnResetEditTranslatePrompt" title="기본값으로 초기화">
                                <i class="ri-restart-line"></i> 초기화
                            </button>
                        </label>
                        <textarea id="editTranslateSystemPrompt" rows="6" placeholder="편집 지시어 번역 시스템 프롬프트..."></textarea>
                    </div>
                    
                    <div class="setting-group">
                        <label>
                            편집 지시어 향상 프롬프트
                            <button class="btn btn-xs btn-secondary" id="btnResetEditEnhancePrompt" title="기본값으로 초기화">
                                <i class="ri-restart-line"></i> 초기화
                            </button>
                        </label>
                        <textarea id="editEnhanceSystemPrompt" rows="6" placeholder="편집 지시어 향상 시스템 프롬프트..."></textarea>
                    </div>
                    
                    <div class="setting-group">
                        <label>
                            편집 제안 프롬프트
                            <button class="btn btn-xs btn-secondary" id="btnResetEditSuggestPrompt" title="기본값으로 초기화">
                                <i class="ri-restart-line"></i> 초기화
                            </button>
                        </label>
                        <textarea id="editSuggestSystemPrompt" rows="6" placeholder="편집 제안 시스템 프롬프트..."></textarea>
                    </div>
                    
                    <button class="btn btn-secondary" id="btnSaveEditSystemPrompts">
                        <i class="ri-save-line"></i> 편집 시스템 프롬프트 저장
                    </button>
                </div>
                
                <div class="settings-section">
                    <h3>📁 출력 설정</h3>
                    <div class="setting-group">
                        <label>파일명 패턴</label>
                        <select id="filenamePatternSelect">
                            <option value="{date}_{time}_{seed}">날짜_시간_시드</option>
                            <option value="{prompt_short}_{seed}">프롬프트_시드</option>
                            <option value="image_{counter}_{seed}">image_번호_시드</option>
                        </select>
                    </div>
                </div>
                
                <div class="settings-section about-section">
                    <h3>ℹ️ 정보</h3>
                    <div class="about-content">
                        <div class="about-item">
                            <i class="ri-user-line"></i>
                            <span class="about-label">제작자</span>
                            <a href="https://github.com/PriuS2" target="_blank" rel="noopener noreferrer">
                                <i class="ri-github-fill"></i> PriuS2
                            </a>
                        </div>
                        <div class="about-item">
                            <i class="ri-git-repository-line"></i>
                            <span class="about-label">프로젝트</span>
                            <a href="https://github.com/PriuS2/Z-Image_WebUI" target="_blank" rel="noopener noreferrer">
                                <i class="ri-github-fill"></i> Z-Image_WebUI
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- 사용자 관리 (관리자 전용) -->
                <div class="settings-section" id="userManagementSection" style="display: none;">
                    <h3>👤 사용자 관리 (관리자 전용)</h3>
                    <p class="setting-description">등록된 사용자 계정을 관리합니다.</p>
                    <div class="user-list" id="userList">
                        <!-- 동적으로 사용자 목록이 추가됨 -->
                    </div>
                    <button class="btn btn-secondary" id="btnRefreshUsers">
                        <i class="ri-refresh-line"></i> 사용자 목록 새로고침
                    </button>
                </div>
                
                <!-- 세션 관리 (관리자 전용) -->
                <div class="settings-section" id="sessionManagementSection" style="display: none;">
                    <h3>📊 세션 관리 (관리자 전용)</h3>
                    <p class="setting-description">현재 활성 세션을 관리합니다.</p>
                    <div class="session-list" id="sessionList">
                        <div class="session-list-header">
                            <span>세션 ID</span>
                            <span>사용자</span>
                            <span>마지막 활동</span>
                            <span>데이터 크기</span>
                            <span>작업</span>
                        </div>
                        <!-- 동적으로 세션 목록이 추가됨 -->
                    </div>
                    <button class="btn btn-secondary" id="btnRefreshSessions">
                        <i class="ri-refresh-line"></i> 새로고침
                    </button>
                </div>
                
                <div class="settings-section credits-section">
                    <h3>🙏 크레딧</h3>
                    <div class="credits-content">
                        <div class="credit-item">
                            <a href="https://huggingface.co/Tongyi-MAI/Z-Image-Turbo" target="_blank" rel="noopener noreferrer">
                                <i class="ri-image-ai-line"></i> Tongyi-MAI/Z-Image-Turbo
                            </a>
                            <span class="credit-desc">이미지 생성 모델</span>
                        </div>
                        <div class="credit-item">
                            <a href="https://huggingface.co/meituan-longcat/LongCat-Image-Edit" target="_blank" rel="noopener noreferrer">
                                <i class="ri-edit-line"></i> meituan-longcat/LongCat-Image-Edit
                            </a>
                            <span class="credit-desc">이미지 편집 모델</span>
                        </div>
                        <div class="credit-item">
                            <a href="https://huggingface.co/jayn7/Z-Image-Turbo-GGUF" target="_blank" rel="noopener noreferrer">
                                <i class="ri-file-reduce-line"></i> jayn7/Z-Image-Turbo-GGUF
                            </a>
                            <span class="credit-desc">GGUF 양자화 모델</span>
                        </div>
                        <div class="credit-item">
                            <a href="https://github.com/huggingface/diffusers" target="_blank" rel="noopener noreferrer">
                                <i class="ri-github-fill"></i> Hugging Face Diffusers
                            </a>
                            <span class="credit-desc">파이프라인 프레임워크</span>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>
    
    <!-- 모달: 이미지 뷰어 (전체화면 미리보기) -->
    <div class="modal image-preview-modal" id="imageModal">
        <div class="image-preview-backdrop" id="imagePreviewBackdrop"></div>
        <div class="image-preview-container">
            <!-- 상단 컨트롤 -->
            <div class="image-preview-controls">
                <div class="preview-controls-left">
                    <button class="preview-btn" id="btnZoomOut" title="축소 (-)">
                        <i class="ri-zoom-out-line"></i>
                    </button>
                    <span class="zoom-level" id="zoomLevel">100%</span>
                    <button class="preview-btn" id="btnZoomIn" title="확대 (+)">
                        <i class="ri-zoom-in-line"></i>
                    </button>
                    <button class="preview-btn" id="btnZoomFit" title="화면에 맞추기">
                        <i class="ri-fullscreen-line"></i>
                    </button>
                    <button class="preview-btn" id="btnZoomOriginal" title="원본 크기 (1:1)">
                        <i class="ri-aspect-ratio-line"></i> 1:1
                    </button>
                </div>
                <div class="preview-controls-right">
                    <button class="preview-btn" id="btnEditThisImage" title="이 이미지를 편집 탭에서 편집">
                        <i class="ri-edit-line"></i> 이미지 편집
                    </button>
                    <button class="preview-btn" id="btnDownloadImage" title="다운로드">
                        <i class="ri-download-2-line"></i>
                    </button>
                    <button class="preview-btn preview-close" id="closeImageModal" title="닫기 (ESC)">
                        <i class="ri-close-line"></i>
                    </button>
                </div>
            </div>
            
            <!-- 이미지 영역 -->
            <div class="image-preview-wrapper" id="imagePreviewWrapper">
                <!-- 이전 이미지 버튼 -->
                <button class="preview-nav-btn prev" id="btnPrevImage" title="이전 이미지 (←)">
                    <i class="ri-arrow-left-s-line"></i>
                </button>
                
                <img id="modalImage" src="" alt="" draggable="false">
                
                <!-- 다음 이미지 버튼 -->
                <button class="preview-nav-btn next" id="btnNextImage" title="다음 이미지 (→)">
                    <i class="ri-arrow-right-s-line"></i>
                </button>
            </div>
            
            <!-- 이미지 인덱스 표시 -->
            <div class="image-preview-counter" id="imageCounter"></div>
            
            <!-- 이미지 정보 -->
            <div class="image-preview-info" id="modalInfo"></div>
        </div>
    </div>
    
    <!-- 모달: 템플릿 선택 -->
    <div class="modal" id="templateModal">
        <div class="modal-content">
            <h3>프롬프트 템플릿</h3>
            <div class="template-list" id="templateList"></div>
            <button class="btn btn-secondary" onclick="closeModal('templateModal')">닫기</button>
        </div>
    </div>
    
    <!-- 모달: 즐겨찾기 저장 -->
    <div class="modal" id="saveFavoriteModal">
        <div class="modal-content">
            <h3>즐겨찾기 저장</h3>
            <input type="text" id="favNameInput" placeholder="이름">
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('saveFavoriteModal')">취소</button>
                <button class="btn btn-primary" id="btnSaveFavorite">저장</button>
            </div>
        </div>
    </div>
    
    <!-- 모달: 갤러리에서 이미지 선택 -->
    <div class="modal" id="gallerySelectModal">
        <div class="modal-content gallery-select-content">
            <div class="modal-header">
                <h3><i class="ri-gallery-line"></i> 갤러리에서 선택</h3>
                <button class="modal-close" onclick="closeModal('gallerySelectModal')">×</button>
            </div>
            <div class="gallery-select-grid" id="gallerySelectGrid">
                <!-- 동적으로 생성됨 -->
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('gallerySelectModal')">취소</button>
            </div>
        </div>
    </div>
    
    <!-- 모달: 비밀번호 변경 -->
    <div class="modal" id="changePasswordModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="ri-lock-password-line"></i> 비밀번호 변경</h3>
                <button class="modal-close" onclick="closeModal('changePasswordModal')">×</button>
            </div>
            <form id="changePasswordForm">
                <div class="form-group">
                    <label>현재 비밀번호</label>
                    <input type="password" id="currentPasswordInput" required>
                </div>
                <div class="form-group">
                    <label>새 비밀번호</label>
                    <input type="password" id="newPasswordInput" required>
                </div>
                <div class="form-group">
                    <label>새 비밀번호 확인</label>
                    <input type="password" id="newPasswordConfirmInput" required>
                </div>
                <div class="form-error" id="changePasswordError"></div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('changePasswordModal')">취소</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="ri-check-line"></i> 변경
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <script src="/static/js/app.js"></script>
</body>
</html>
